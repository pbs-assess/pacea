---
title: "ROMS data wrangling"
author: "Travis Tai"
date: "2023-07-20"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

We wrangle the ROMS geospatial data for some quick qualitative analyses.

```{r ROMS}

# load packages and pacea data

# run this if pacea has not been installed
#remotes::install_github("pbs-assess/pacea")

library(pacea)
library(dplyr)
library(sf)
library(ggplot2)

# data should already be downloaded to cache folder and name object
pdata <- roms_surface_temperature()
```


#### Obtain centroids of each cell

Currently, the ROMS data are simple feature (sf) objects of polygons (gridded square cells). The polygon boundaries are identified by coordinates for the perimeter of the cell. We can also obtain the centroids of each cell.

```{r}
# this will replace convert the geometry column from a polygon to a point, with the centroid of the gridded cell
centroid.dat <- pdata %>% st_centroid()
```

#### Extract specific time periods

Wrangle data to select months of interest and into long format for easy plotting with ggplot.

```{r}

# months and years of interest
yrs <- c(1999, 2009, 2019)
mths <- c(8) # august
ym <- paste(yrs, mths, sep = "_")

# subset data based on year_month column name
tdat <- pdata %>%
  dplyr::select(all_of(ym))

# wrangle data to long format and add columns for year and month
sub.dat <- tdat %>%
  tidyr::pivot_longer(cols = !last_col(), cols_vary = "slowest", names_to = "date", values_to = "value")  %>%
  mutate(year = substr(date, 1, 4),
         month = substr(date, 6, 7)) %>%
  relocate(geometry, .after = last_col()) 
```

Plot selected time periods for visual exploration.

```{r}
p1 <- ggplot(data = sub.dat) +
  geom_sf(aes(fill = value), col = NA) +
  facet_grid(month~year) +
  scale_fill_continuous(name = attributes(pdata)$units)
p1
```

Adding BC coast layer and BC EEZ layer

```{r}
p2 <- p1 + 
  geom_sf(data = bc_eez, fill = NA, lty = 2) + 
  geom_sf(data = bc_coast)
p2
```

We can find the mean value across the entire area for the months and years selected

```{r}
sub.dat %>%
  st_drop_geometry() %>% # drop geometry to increase processing speed
  group_by(date, year, month) %>%
  summarize(mean_value = mean(value, na.rm = TRUE))
```


#### Mean values across a spatial area of interest

If we're interested in a specific area and want to view the spatial trends over time, we can mask the data using a `sf` polygon.

```{r}
# coordinates for polygon (i.e. this are the coordinates for DFO Pacific fishing area 126)
crds <- list(matrix(c(-127.1506, -128.2331, -129.3492, -127.9167, -127.1847, -126.8200, -127.1506,
                      49.85766, 49.00000, 48.99991, 50.11915, 50.40183, 50.24466, 49.85766), ncol = 2))

# create polygon object and convert to sf object with bc albers projection
a126 <- st_sfc(st_polygon(crds), crs = 4326) %>% 
  st_as_sf() %>%
  st_transform(crs = 3005)

# mask data by indexing sf object with area 126 shapefile 
reg.dat <- sub.dat[a126, ]

# plot panel of data
reg.p1 <- ggplot(data = reg.dat) +
  geom_sf(aes(fill = value), col = NA) +
  facet_grid(month~year) +
  scale_fill_continuous(name = attributes(pdata)$units)

reg.p1
```

Next, We can estimate the mean value across the area of interest for the entire time series.

```{r}
# subset data with area of interest (Area 126) and convert to long format 
reg.dat2 <- pdata[a126, ] %>% 
  tidyr::pivot_longer(cols = !last_col(), cols_vary = "slowest", names_to = "date", values_to = "value")  %>%
  mutate(year = as.numeric(substr(date, 1, 4)),
         month = as.numeric(substr(date, 6, 7))) %>%
  relocate(geometry, .after = last_col()) 

# we need to get the area of each cell so we can weight the mean
reg.dat2 <- reg.dat2 %>%
  mutate(area = as.vector(st_area(reg.dat2)))

# now we can drop the geometry as we don't need that for this analysis (and it slows down processing)
reg.dat2 <- st_drop_geometry(reg.dat2)

# summarise the data across the entire Area 126 with a weighted mean by gridded cell area
sum.dat <- reg.dat2 %>%
  group_by(year, month) %>%
  summarise(value = weighted.mean(value, area, na.rm = T)) 

# find the monthly mean across the time series
mean.dat <- sum.dat %>%
  group_by(month) %>%
  summarise(mean_value = mean(value, na.rm = T))

```

We can plot the time series to look at seasonal trends.

```{r}
sum.dat %>%
  mutate(year = as.factor(year)) %>%  # set year to a factor so each line is plotted separately
  ggplot() + 
  geom_line(aes(x = month, y = value, col = year)) 
```

Any trends are difficult to see, so let's revise the colour scheme

```{r}
sum.dat %>%
  mutate(year = as.factor(year)) %>%
  ggplot() +
  geom_line(aes(x = month, y = value, col = as.factor(year))) + 
  scale_color_manual(values = colorRampPalette(c("orange", "blue"))(27), name = "year") 
```

Still no clear visual pattern. Let's look at the past 10 years compared to the time series mean.

```{r}
sum.dat %>%
  filter(year >= 2010) %>%
  mutate(year = as.factor(year)) %>%
  ggplot() +
  geom_line(aes(x = month, y = value, col = as.factor(year))) + 
  geom_line(data = mean.dat, aes(x = month, y = mean_value), col = "black", linewidth = 2) +
  scale_color_manual(values = colorRampPalette(c("orange", "blue"))(10), name = "year") 
```

The dark black line is the time series mean and while there isn't an clear trend, the later years in the past decade appear to have higher temperatures (particularly in the summer) than the earlier part of the decade. 


#### Extract data using coordinates

We can extract the spatial data using coordinates of interest. We can use the same indexing to extract gridded cells where the coordinate data fall into. This could be used to compare the modelled ROMS data with field observations.

We'll use the location of data buoys. There is a list of buoys and locations in this pacakge, named as object: `buoy_metadata`.

```{r}
buoy_metadata

# Let's use the La Perouse Bank location 
lat <- buoy_metadata$latitude[which(buoy_metadata$name == "La Perouse Bank")]
lon <- buoy_metadata$longitude[which(buoy_metadata$name == "La Perouse Bank")]

# create a dataframe and convert to sf object
coords_LP <- data.frame(x = lon, y = lat)
sf_LP <- st_as_sf(coords_LP, coords = c("x", "y"), crs = "EPSG: 4326")
sf_LP

# transform to correct projection
sf_LP <- sf_LP %>% st_transform(crs = "EPSG: 3005")

# extract cells for which coordinates fall into and wrangle to long format for plotting
point.dat <- pdata[sf_LP,] %>%
  tidyr::pivot_longer(cols = !last_col(), cols_vary = "slowest", names_to = "date", values_to = "value")  %>%
  mutate(year = as.numeric(substr(date, 1, 4)),
         month = as.numeric(substr(date, 6, 7))) %>%
  relocate(geometry, .after = last_col()) 

# plot to view seasonal trends across years
point.dat %>%
  mutate(year = as.factor(year)) %>%
  ggplot() +
  geom_line(aes(x = month, y = value, col = as.factor(year))) + 
  scale_color_manual(values = colorRampPalette(c("orange", "blue"))(27), name = "year") 

```




